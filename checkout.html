<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">

  <style>
    body {
      max-width: 800px;
      margin: 0 auto;
    }
    progress {
      display: none;
      /* width: 100%; */
    }
    .active {
      display: block;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>

  <h1>Checkout</h1>
  <p>Your email: <span id="email"></span></p>
  <!-- inputs for content details, script, copy/assets -->
  <form>
    <label for="details">Content Details</label>
    <textarea name="details" id="details" cols="30" rows="10" required></textarea>

    <label for="script">Script</label>
    <textarea name="script" id="script" cols="30" rows="10" required></textarea>

    <label for="assets">Copy/Assets</label>
    <textarea name="assets" id="assets" cols="30" rows="10" required></textarea>

    <input type="submit" value="Submit" class="contrast">

    <progress></progress>
  </form>

  <script>
    // get the values from the url
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const deliverable = urlParams.get('deliverable');
    
    // set email in the page
    const emailEl = document.querySelector('#email');
    emailEl.textContent = email;

    // get form data
    const form = document.querySelector('form');
    
    form.addEventListener('submit', (e) => {
      e.preventDefault();

      // if loading, show progress bar
      const progress = document.querySelector('progress');
      progress.classList.add('active');

      const details = document.querySelector('#details').value;
      const script = document.querySelector('#script').value;
      const copy = document.querySelector('#assets').value;

      // send data to server
      fetch('https://syncy-backend.onrender.com/book-content-pack/' + deliverable, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          'userEmail': email,
          details,
          "contentScript": script,
          copy
        })
      })
      .then(res => res.json())
      .then(data => {
        console.log(data)
        // check for status and log message
        if (data.status === 'success') {
          console.log('success')
          createCheckoutSession(data?.body?.booking?.id).then(function(data) {
            console.log(data)
            if (data?.status === 'fail') {
              // show error message
              const error = document.createElement('p');
              error.textContent = data.message;
              error.classList.add('error');
              form.appendChild(error);
            } else {
              window.location.href = data?.body?.url;
            }
          });
        } else {
          console.log('error')

          // show error message
          const error = document.createElement('p');
          error.textContent = data.message;
          error.classList.add('error');
          form.appendChild(error);
        }
      })
      .catch(err => {
        console.log(err)        
      });

      // remove progress bar
      progress.classList.remove('active');
    });

    function createCheckoutSession(booking_id) {
      return fetch("https://syncy-backend.onrender.com/create-public-checkout-session", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          bookingId: booking_id,
          userEmail: email
        })
      }).then(function(result) {
        return result.json();
      });
    }
  </script>
</body>
</html>